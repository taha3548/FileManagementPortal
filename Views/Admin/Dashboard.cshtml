<!-- ============================================ -->
<!-- ADMIN DASHBOARD - YÃ¶netim Paneli Ana Sayfa -->
<!-- Bootstrap 5 responsive tasarÄ±m -->
<!-- SignalR canlÄ± bildirimler -->
<!-- Ä°statistik kartlarÄ± ve aktivite takibi -->
<!-- ============================================ -->
@model FileManagementPortal.ViewModels.AdminDashboardViewModel
@{
    ViewData["Title"] = "YÃ¶netim Paneli";
}

<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-speedometer2 me-2"></i>YÃ¶netim Paneli</h2>
        <div class="mt-2">
            <span id="adminStatus" class="badge bg-success">BaÄŸlÄ±</span>
            <span id="connectedAdmins" class="badge bg-primary ms-2">Ã‡evrimiÃ§i YÃ¶neticiler: 0</span>
            <span id="onlineUsersCount" class="badge bg-info ms-2">
                <i class="bi bi-circle-fill" style="font-size: 0.6rem;"></i>
                Ã‡evrimiÃ§i KullanÄ±cÄ±lar: <span id="onlineCount">0</span>
            </span>
            <span class="badge bg-info ms-2">Toplam KullanÄ±cÄ±: @Model.TotalUserCount</span>
        </div>
    </div>
</div>

<!-- SignalR canlÄ± aktivite bildirimleri -->
<!-- GerÃ§ek zamanlÄ± bildirimler iÃ§in SignalR Hub baÄŸlantÄ±sÄ± -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header text-white" style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);">
                <h5 class="mb-0"><i class="bi bi-lightning-fill me-2"></i>CanlÄ± Aktiviteler</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <div id="activityFeed" class="list-group list-group-flush">
                    <p class="text-muted mb-0">Aktivite bekleniyor...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ä°statistik kartlarÄ± -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="stats-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 1.5rem;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="card-subtitle mb-2" style="color: #000000 !important;">Toplam Dosya</h6>
                    <h3 class="mb-0 fw-bold" style="color: #000000 !important;">@Model.TotalFileCount</h3>
                </div>
                <i class="bi bi-files fs-1" style="color: #000000 !important; opacity: 0.5;"></i>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="stats-card" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); padding: 1.5rem;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="card-subtitle mb-2" style="color: #000000 !important;">Toplam Kategori</h6>
                    <h3 class="mb-0 fw-bold" style="color: #000000 !important;">@Model.TotalCategoryCount</h3>
                </div>
                <i class="bi bi-tags fs-1" style="color: #000000 !important; opacity: 0.5;"></i>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="stats-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 1.5rem;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="card-subtitle mb-2" style="color: #000000 !important;">Toplam Boyut</h6>
                    <h3 class="mb-0 fw-bold" style="color: #000000 !important;">@((Model.TotalFileSize / 1024.0 / 1024.0).ToString("F2")) MB</h3>
                </div>
                <i class="bi bi-hdd fs-1" style="color: #000000 !important; opacity: 0.5;"></i>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 1.5rem;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="card-subtitle mb-2" style="color: #000000 !important;">Toplam KullanÄ±cÄ±</h6>
                    <h3 class="mb-0 fw-bold" style="color: #000000 !important;">@Model.TotalUserCount</h3>
                </div>
                <i class="bi bi-people fs-1" style="color: #000000 !important; opacity: 0.5;"></i>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="stats-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); padding: 1.5rem;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="card-subtitle mb-2" style="color: #000000 !important;">Toplam YÃ¶netici</h6>
                    <h3 class="mb-0 fw-bold" style="color: #000000 !important;">@Model.TotalAdminCount</h3>
                </div>
                <i class="bi bi-shield-check fs-1" style="color: #000000 !important; opacity: 0.5;"></i>
            </div>
        </div>
    </div>
</div>

<!-- Son yÃ¼klenen ve en Ã§ok indirilen dosyalar -->
<div class="row g-3">
    <div class="col-md-6">
        <div class="card shadow-sm border-0">
            <div class="card-header text-white" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Son YÃ¼klenen Dosyalar</h5>
            </div>
            <div class="card-body">
                @if (Model.RecentlyUploadedFiles != null && Model.RecentlyUploadedFiles.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var file in Model.RecentlyUploadedFiles)
                        {
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">@file.FileName</h6>
                                        <small class="text-muted">@file.UploadedAt.ToString("dd.MM.yyyy HH:mm")</small>
                                    </div>
                                    <a href="@Url.Action("Edit", "File", new { id = file.Id })" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted mb-0">HenÃ¼z dosya yok.</p>
                }
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card shadow-sm border-0">
            <div class="card-header text-white" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>En Ã‡ok Ä°ndirilen Dosyalar</h5>
            </div>
            <div class="card-body">
                @if (Model.MostDownloadedFiles != null && Model.MostDownloadedFiles.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var file in Model.MostDownloadedFiles)
                        {
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">@file.FileName</h6>
                                        <small class="text-success fw-bold">
                                            <i class="bi bi-download me-1"></i>@file.DownloadCount indirme
                                        </small>
                                    </div>
                                    <a href="@Url.Action("Edit", "File", new { id = file.Id })" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted mb-0">HenÃ¼z indirme yok.</p>
                }
            </div>
        </div>
    </div>
</div>

<!-- HÄ±zlÄ± eriÅŸim butonlarÄ± -->
<div class="row mt-4">
    <div class="col-12">
        <div class="d-flex gap-2 flex-wrap">
            <a asp-action="Files" class="btn btn-primary">
                <i class="bi bi-files me-2"></i>TÃ¼m DosyalarÄ± YÃ¶net
            </a>
            <a asp-action="Categories" class="btn btn-success">
                <i class="bi bi-tags me-2"></i>Kategorileri YÃ¶net
            </a>
            <a asp-action="Users" class="btn btn-success">
                <i class="bi bi-people me-2"></i>KullanÄ±cÄ±larÄ± YÃ¶net
            </a>
        </div>
    </div>
</div>


@section Scripts {
    <!-- SignalR kÃ¼tÃ¼phanesi -->
    <script src="~/lib/signalr/signalr.js"></script>
    <script>
        // SignalR baÄŸlantÄ±sÄ± - Admin Hub
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/hubs/admin")
            .withAutomaticReconnect()
            .build();

        connection.start().catch(err => console.error('SignalR hatasÄ±:', err));

        // SignalR baÄŸlantÄ±sÄ± - User Hub (Ã‡evrimiÃ§i kullanÄ±cÄ± takibi)
        const userConnection = new signalR.HubConnectionBuilder()
            .withUrl("/hubs/user")
            .withAutomaticReconnect()
            .build();

        userConnection.start()
            .then(() => {
                console.log('User Hub baÄŸlantÄ±sÄ± kuruldu');
                // Ä°lk baÄŸlantÄ±da Ã§evrimiÃ§i kullanÄ±cÄ±larÄ± al
                userConnection.invoke("GetOnlineUsers").catch(err => console.error(err));
            })
            .catch(err => console.error('User Hub hatasÄ±:', err));

        // KullanÄ±cÄ± baÄŸlandÄ±ÄŸÄ±nda
        userConnection.on("UserConnected", (userId, onlineUserIds) => {
            updateOnlineCount(onlineUserIds.length);
        });

        // KullanÄ±cÄ± ayrÄ±ldÄ±ÄŸÄ±nda
        userConnection.on("UserDisconnected", (userId, onlineUserIds) => {
            updateOnlineCount(onlineUserIds.length);
        });

        // Ã‡evrimiÃ§i kullanÄ±cÄ± listesi geldiÄŸinde
        userConnection.on("OnlineUsers", (onlineUserIds) => {
            updateOnlineCount(onlineUserIds.length);
        });

        // Ã‡evrimiÃ§i kullanÄ±cÄ± sayÄ±sÄ±nÄ± gÃ¼ncelle
        function updateOnlineCount(count) {
            document.getElementById('onlineCount').textContent = count;
        }

        // Sunucudan gelen bildirimler - GerÃ§ek zamanlÄ±
        connection.on("AdminConnected", (adminId, count) => {
            document.getElementById('connectedAdmins').textContent = `BaÄŸlÄ± YÃ¶neticiler: ${count}`;
            addActivityFeed(`YÃ¶netici baÄŸlandÄ±`, 'info');
        });

        connection.on("AdminDisconnected", (count) => {
            document.getElementById('connectedAdmins').textContent = `BaÄŸlÄ± YÃ¶neticiler: ${count}`;
            addActivityFeed(`YÃ¶netici baÄŸlantÄ±sÄ± kesildi`, 'warning');
        });

        connection.on("FileUploaded", (data) => {
            addActivityFeed(`ðŸ“¤ ${data.FileName} yÃ¼klendi`, 'success');
        });

        connection.on("FileDownloaded", (data) => {
            addActivityFeed(`ðŸ“¥ ${data.FileName} indirildi`, 'info');
        });

        connection.on("FileDeleted", (data) => {
            addActivityFeed(`ðŸ—‘ï¸ ${data.FileName} silindi`, 'danger');
        });

        connection.on("UserRegistered", (data) => {
            addActivityFeed(`ðŸ‘¤ Yeni kullanÄ±cÄ±: ${data.UserEmail}`, 'success');
        });

        // Aktivite listesine mesaj ekle - DOM manipÃ¼lasyonu
        function addActivityFeed(message, type) {
            const feed = document.getElementById('activityFeed');
            const item = document.createElement('div');
            item.className = `list-group-item px-0 border-bottom`;
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="mb-1">${message}</p>
                        <small class="text-muted">${new Date().toLocaleTimeString('tr-TR')}</small>
                    </div>
                    <span class="badge bg-${type}">Yeni</span>
                </div>
            `;
            feed.insertBefore(item, feed.firstChild);
            while (feed.children.length > 10) {
                feed.removeChild(feed.lastChild);
            }
        }

        connection.invoke("GetConnectedAdminsCount").catch(err => console.error(err));

        // BaÄŸlantÄ± durumu kontrolÃ¼
        connection.onreconnecting(() => {
            document.getElementById('adminStatus').textContent = 'Yeniden baÄŸlanÄ±yor...';
            document.getElementById('adminStatus').className = 'badge bg-warning';
        });

        connection.onreconnected(() => {
            document.getElementById('adminStatus').textContent = 'BaÄŸlÄ±';
            document.getElementById('adminStatus').className = 'badge bg-success';
        });

        connection.onclose(() => {
            document.getElementById('adminStatus').textContent = 'BaÄŸlantÄ± Kesildi';
            document.getElementById('adminStatus').className = 'badge bg-danger';
        });
    </script>
}
